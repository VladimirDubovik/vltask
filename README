Репозиторий содержит:
1) настоящий файл описания репозитория
2) файл конфигурации Ansible
3) файлы описания окружений в каталоге /inventory
4) файлы шаблонов в каталоге /templates
5) файл сценария site.yml

Структура репозитория:
.
├── ansible.cfg
├── inventory
│   ├── one
│   │   └── hosts
│   ├── three
│   │   └── hosts
│   └── two
│       └── hosts
├── README
├── site.yml
└── templates
    ├── script.j2
    ├── settings.j2
    └── text.j2

ФАЙЛ КОНФИГУРАЦИИ ANSIBLE

Файл конфигурации Ansible определяет ряд параметров, в т.ч. имя каталога описания окружений (./inventory), расположение .log-файла (./log)
** .log-файл не включен в репозиторий

ФАЙЛЫ ОПИСАНИЯ ОКРУЖЕНИЙ

В каталог описания окружений (./inventory) помещено три подкаталога: one, two, three. Каждый подкаталог содержит инвентарный файл hosts. Файл hosts для каждого окружения имеет след. структуру:
1) группу действительный живых хостов (alive hosts)  [ahosts]
2) группу несуществующих хостов-призраков (ghosts) [ghosts]
3) локальный хост [localhost]
4) переменные группы [ghosts:vars]
5) переменные всего окружения [all:vars]

Группа действующих живых хостов [ahosts] для каждого окружения включает один хост: 192.168.43.184. Для подключения к этому хосту используется порт по умолчанию (22).

Группа хостов-призраков [ghosts] для каждого окружения вкл. три хоста (в таблице):
one               | two            | three
192.168.43.25.250 | 192.168.43.250 | 192.168.43.25.249
192.168.43.25.251 | 192.168.43.252 | 192.168.43.25.251
192.168.43.25.252 | 192.168.43.254 | 192.168.43.25.253

Локальный хост [localhost] для каждого окружения: 192.168.43.110

Порт подключения (ansible_port) к группе хостов [ghosts] для кажого окружения задан:
one: 123; two: 124; three: 125

Имя окружения (inventory_name) для каждого окружения задана соответственно:
one: one; two: two; three: three

ФАЙЛЫ ШАБЛОНОВ

В каталог шаблонов (./templates) помещено три файла: script.j2, settings.j2, text.j2. Каждый файл содержит описание шаблонов для шаблонизатора Jinja2. После запуска сценария эти файлы шаблонизируются и передаются на удаленный хост.

Файл script.j2 на удаленном хосте получает имя script.sh. Файл содержит перечень shell-команд: для вывода времени запуска в .log-файл, для вывода текста из файлов text.txt и settings.cfg, для вывода имени текщего окружения. Команда вывода имени текущего окружения помещается в файл shell.sh в том случае, если при запуске сценария передана переменная print_cur_env (c любым значением). Время запуска помещается в файл log.txt в каталоге ~/log/log.txt. Формат записи: "Start at ГГГГ.ММ.ДД ЧЧ:ММ".

Файл settings.j2 на удаленном хосте получает имя settings.cfg. В файл помещается строка со списком хостов-призраков для выбранного окружения. Формат строки: servers = { ip:port, ip:port, ... }

Файл text.js2 на удаленном хосте получает имя text.txt. В исходный файл помещены три текстовых блока. Каждый блок соответствует определенному окружению. После шаблонизации в результируюший файл помещается только один текстовый фрагмент для выбранного окружения.

ФАЙЛ СЦЕНАРИЯ

В файле сценария указаны параметры выполнения:
- user: test
  пользователь test на удаленном хосте
- hosts: ahosts
  группа хостов [ahosts]
- gatcher_fact: false

Далее, в файле сценария описано выполение след. задач:
1) создание на удаленном хосте каталога ~/config
2) создание на удаленном хосте каталога ~/log
3) отправка на удаленный хост файла text.txt
4) отправка на удаленный хост файла settings.txt
5) отправка на удаленный хост файла script.sh
6) выполнение на удаленном хосте файла script.sh
7) отображение результатов выполнения файла scripth.sh

ЗАПУСК СЦЕНАРИЯ

Для запуска сценария (play) вызывается программа ansible-plybook. Формат вызова:
$ ansible-playbook -i inventory/[one|two|three] [-e print_cur_env = true] site.yml

После запуска сценария:
1) на удаленном хосте в домашней папке пользователя test создаются два каталога: ~/config и ~/log
2) в каталог ~/config помещаются файлы text.txt и settings.cfg
3) в домашней папке пользователя test создается файл shell.sh
4) запускается файл shell.sh
5) после запуска файла в каталоге ~/log создается файл log.txt (если файл существует, то он не удаляется и его содержимое не очищается)
6) в файл log.txt добавляется строка "start at ...", где вместо ... дата и время запуска файла (дата и время в формате: год.месяц.день час:минута)
7) на терминал удаленного хоставыводится текстовый блок из файла ~/config/text.txt и строка из файла ~/config/settings.cfg
8) вывод на терминал удаленного хоста выводится в консоли выполнения сценария на контроллере
9) в файл ./log/ansible.log добавляеются все строки, выведенные на терминал в процессе выполнения сценария

После выполнения сценария файлы на удаленном и локальном хостах не изменяются и не удаляются. При повторном запуске сценария файлы script.sh, settings.cfg и text.txt перезаписываются. Файл log.txt не удаляетяс и не перезаписывается.
